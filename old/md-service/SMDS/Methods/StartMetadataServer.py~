#!/usr/bin/python

from SMDS.method import Method
from SMDS.mdserver import *
from SMDS.user import *
from SMDS.parameter import *
from SMDS.auth import Auth
from SMDS.filter import *
from SMDS.faults import *

class StartMetadataServer( Method ):
   """
   Activate an existing metadata server.  The caller must own the metadata server, unless they are an admin.
   """
   
   accepts = [
         Auth(),
         MDServer.fields['server_id']
   ]
   roles = ['admin','user']
   returns = Parameter([str], "The read and write URLs of the metadata server (on success)")
   
   def call( self, auth, mdserver_id ):
      roles = []
      if self.caller:
         roles = self.caller
         
      users = Users( self.api, {'username': auth['Username']}
      user = users[0]
      
      mdserver = None
      try:
         mdservers = MDServers( self.api, {'server_id': mdserver_id})
         mdserver = mdservers[0]
      except Exception, e:
         raise MDObjectNotFound( "MDServer(%s)", mdserver_id, e )
      
      if (self.caller == None or 'admin' not in roles) and mdserver['owner'] != user['user_id']:
         raise MDUnauthorized( "MDServer(%s) cannot be started by User(%s)" % (mdserver_id, user['username']) )
      
      return mdserver.start_server()
   