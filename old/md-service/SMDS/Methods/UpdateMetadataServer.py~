#!/usr/bin/python

from SMDS.method import Method
from SMDS.mdserver import *
from SMDS.user import *
from SMDS.parameter import *
from SMDS.auth import Auth
from SMDS.faults import *

import urllib2

class UpdateMetadataServer( Method ):
   """
   Update a metadata server. A user can only update a metadata server that he/she owns.  An admin can update any metadata server.
   """
   
   accepts = [
         Auth(),
         Mixed( MDServer.fields['server_id'], MDServer.fields['name'] ),
         dict([(n,MDServer.fields[n]) for n in set(MDServer.fields.keys()).difference(set(['server_id', 'users', 'status', 'name']))])
   ]
   roles = ['admin','user']
   returns = Parameter(int, "1 if successful; negative error code otherwise")
   
   def call(self, auth, mdserver_name_or_id, mdserver_fields):
      assert self.caller is not None
      
      roles = self.caller['roles']
      
      # look up the user ID
      users = Users( self.api, {'username': auth['Username']} )
      user = users[0]
      
      # look up this metadata server
      mdserver = None
      try:
         mdservers = []
         if isinstance(mdserver_name_or_id, str):
            mdservers = MDServers( self.api, {'name': mdserver_name_or_id} )
         else:
            mdservers = MDServers( self.api, {'server_id': mdserver_name_or_id} )
            
         mdserver = mdservers[0]
      except Exception, e:
         raise MDObjectNotFound( "MDServer(%s)" % mdserver_name_or_id )
      
      # sanity check
      if ('admin' not in roles) and mdserver['server_id'] not in user['mdserver_ids']:
         raise MDUnauthorized( "User(%s) cannot update MDServer(%s)" % (auth['Username'], mdserver_name_or_id) )
      
      # url-encode the name
      if mdserver_fields.get('name'):
         mdserver_fields['name'] = urllib2.quote( mdserver_fields['name'] )
      
      old_name = mdserver['name']
      
      mdserver.update( mdserver_fields )
      
      new_name = mdserver['name']
      
      mdserver.sync()
      return mdserver.restart_server( old_name, new_name )